require 'net/http'
require 'uri'
require 'nokogiri'
require 'rkelly'
require 'json'

class Reserve
  attr_reader :room, :date, :cookie
  def initialize(room, date=nil)
    @room = room
    @date = date
    @cookie = "_ga=GA1.2.299807075.1542114254; _gid=GA1.2.1449767227.1550555584; NID_SES=AAABpA7/XiTsCVURizNrVXHSkFPpCWBfC3V/eVKtxapOamX+dCNjyZbMZ1A7MCryGsaGNlmUkbi1IA9x4nKUGSinFrY1CiEzsuPt8SW/i22u2aA6Sy4sYwCYOhoA5nSUh2zKjICFEun0FZkZpwIzaLGbLExdFaxmkWLQ1c/BPvkgyXB71u5xUUxpnMLudlpQsN+q+t/7go+871T3uCa9e0yrJXzYZvOIaBF0s87jct62CU4zOjvvfiRwIKJ02kJlYC59HAsqNdq6SWkF/H/1TkUcvorBILzPMT5xfLQ2LI2wFwHhiAvZmt2UloJiM7ESwAOCxozcdk4bBHa6M5IjFOJLMV1Q6NS+o2jVbzJijP9Y/31pVShblAnSl5npUEBPVMFrOXnM0PXc8DRoA8H3plPGDfVjGuftpwqRvSiyb2yKjyys9OWRI89r2I7pIG6BAaNDdkoy05qxCS/XZGBb7qGKbzb2cU0nsyoy9Y5AYuXVpM6BXApDFwZV6Plv0glmAfmXDXBz5Q8qeHb+lWDhn/jCM+PLqxw1bItUN/3pZ/IKnxxkCK1KTJ/8F5hyqj3c10jZqg==; NID_AUT=8HUpZB+uAcTVGqbMjvydgfmY8x+D7zHxUkl/gkuRW2t3h3mdbSGwV5e4IvjvZgIu; _gat_gtag_UA_123322100_1=1; wcs_bt=b942b9bd976724:1550556587"
  end

  def request
    url = room[:url]
    uri = URI.parse(url)
    request = Net::HTTP::Get.new(uri)
    request["Connection"] = "keep-alive"
    request["Cache-Control"] = "max-age=0"
    request["Upgrade-Insecure-Requests"] = "1"
    request["User-Agent"] = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"
    request["Accept"] = "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8"
    request["Accept-Language"] = "ko,en-US;q=0.9,en;q=0.8,ja;q=0.7,es;q=0.6"
    request["Cookie"] = cookie
    req_options = {
      use_ssl: uri.scheme == "https",
    }

    response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
      http.request(request)
    end
  end

  def raw_script
    <<-JS

    var _needLogin = true;
    var _spaceInfo = {
        spaceId : 3936,
        productId : 6047,
        rsvTpCd : 'TIME',
        perpsPrcYn : 'Y',
        bizStartHour : '9',
        bizEndHour : '23',
        bizHour : '14',
        minRsvTm : '2',
        minRsvDd : '1',
        rsvMthCd : 'NOWPY',
        rgstFirstDay : '20190106',
        rgstFirstDayPlusOneDay : '20190107',
        rgstLastDay : '20190406'
        };

    var _availableCredit = 0;

    var _priceByDate = {"20181230":{"price":1500,"priceByH":[{},{"9":1500,"10":1500,"11":1500,"12":1500},{"13":-1,"14":-1,"15":-1,"16":-1,"17":-1,"18":-1,"19":-1,"20":-1,"21":-1},{"22":1500},{}]},"20181231":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190101":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190102":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700},{"19":-1,"20":-1},{"21":1700,"22":1700},{}]},"20190103":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190104":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190105":{"price":1700,"priceByH":[{},{"9":1700},{"10":-1,"11":-1,"12":-1},{"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190106":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700},{"17":-1,"18":-1},{"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190107":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190108":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190109":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190110":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190111":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190112":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190113":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190114":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190115":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190116":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190117":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190118":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190119":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190120":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190121":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190122":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190123":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190124":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190125":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190126":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190127":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190128":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190129":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190130":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190131":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190201":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]},"20190202":{"price":1700,"priceByH":[{},{"9":1700,"10":1700,"11":1700,"12":1700,"13":1700,"14":1700,"15":1700,"16":1700,"17":1700,"18":1700,"19":1700,"20":1700,"21":1700,"22":1700},{}]}};


    var _breakDays = [];


    var _fullReserveDays = [];


    spacecloud.payment.init(false);

    JS
  end

  def script
    body = request.body
    doc = Nokogiri::HTML(request.body)
    result = doc.css('script')
    result[-1].text
  end

  def parsed_script
    script_node = raw_script
    script_node = script
    parser = RKelly::Parser.new
    ast = parser.parse(script_node)
    _priceByDate = ast.pointcut(RKelly::Nodes::VarStatementNode).matches[-3].to_ecma
    schedule = _priceByDate.gsub('var _priceByDate = ', '')[0..-2]
    JSON.parse(schedule)[date]
  end

  def schedule_empty?
    study_hours = []
    return [] if when_full_schedule
    return [] if need_whole_day_reservation
    return [] if when_full_study_time
    %w[20 21 22].each do |t|
      study_hour = parsed_script["priceByH"][1][t]
      study_hours << { hour: t, price: study_hour }
    end
    study_hours
  end

  def when_full_schedule
    parsed_script.nil?
  end

  def need_whole_day_reservation
    parsed_script.is_a?(Integer)
  end

  def when_full_study_time
    parsed_script["priceByH"][1].nil?
  end

  def hours
    contents = []
    reserv_list.each do |list|
      # attribute = { script: list }
      pp list
      attribute = {  }
      contents << attribute
    end
    contents
  end
end
